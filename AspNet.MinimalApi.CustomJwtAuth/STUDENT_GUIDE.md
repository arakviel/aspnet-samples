# üéì –ü–æ—Å—ñ–±–Ω–∏–∫ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤: –ö–∞—Å—Ç–æ–º–Ω–∞ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è

## üéØ –©–æ –≤–∏ –¥—ñ–∑–Ω–∞—î—Ç–µ—Å—è

–¶–µ–π –ø—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î **–ø–æ–≤–Ω—É –∫–∞—Å—Ç–æ–º–Ω—É —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó** –±–µ–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≥–æ—Ç–æ–≤–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫. –í–∏
–∑—Ä–æ–∑—É–º—ñ—î—Ç–µ:

- üîê –Ø–∫ –ø—Ä–∞—Ü—é—é—Ç—å JWT —Ç–æ–∫–µ–Ω–∏ "–ø—ñ–¥ –∫–∞–ø–æ—Ç–æ–º"
- üîë –Ø–∫ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ç–∞ –≤–∞–ª—ñ–¥—É–≤–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å–∏ —Ç–æ–∫–µ–Ω—ñ–≤
- üé´ –†—ñ–∑–Ω–∏—Ü—é –º—ñ–∂ Access —Ç–∞ Refresh —Ç–æ–∫–µ–Ω–∞–º–∏
- üõ°Ô∏è –Ø–∫ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ middleware –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
- üë• –Ø–∫ –ø—Ä–∞—Ü—é—î —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ JWT

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JWT —Ç–æ–∫–µ–Ω–∞

JWT —Ç–æ–∫–µ–Ω —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ **—Ç—Ä—å–æ—Ö —á–∞—Å—Ç–∏–Ω**, —Ä–æ–∑–¥—ñ–ª–µ–Ω–∏—Ö –∫—Ä–∞–ø–∫–∞–º–∏:

```
header.payload.signature
```

#### 1. Header (–ó–∞–≥–æ–ª–æ–≤–æ–∫)

```json
{
  "alg": "HS256",  // –ê–ª–≥–æ—Ä–∏—Ç–º –ø—ñ–¥–ø–∏—Å—É
  "typ": "JWT"     // –¢–∏–ø —Ç–æ–∫–µ–Ω–∞
}
```

#### 2. Payload (–ö–æ—Ä–∏—Å–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)

```json
{
  "sub": "1",                    // Subject - ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  "username": "admin",           // –Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  "email": "admin@example.com",  // Email
  "role": "Admin",               // –†–æ–ª—å
  "token_type": "access",        // –¢–∏–ø —Ç–æ–∫–µ–Ω–∞
  "iss": "MyApp",               // Issuer - —Ö—Ç–æ –≤–∏–¥–∞–≤ —Ç–æ–∫–µ–Ω
  "aud": "MyApp.Users",         // Audience - –¥–ª—è –∫–æ–≥–æ —Ç–æ–∫–µ–Ω
  "exp": 1640995200,            // Expiration - –∫–æ–ª–∏ –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è
  "iat": 1640991600,            // Issued At - –∫–æ–ª–∏ –≤–∏–¥–∞–Ω–æ
  "jti": "unique-id"            // JWT ID - —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID —Ç–æ–∫–µ–Ω–∞
}
```

#### 3. Signature (–ü—ñ–¥–ø–∏—Å)

```
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret_key
)
```

## üîç –ö–ª—é—á–æ–≤—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

### 1. JwtTokenGenerator - –°–µ—Ä—Ü–µ —Å–∏—Å—Ç–µ–º–∏

````csharp
public string GenerateAccessToken(User user)
{
    var claims = CreateAccessTokenClaims(user);
    var expirationTime = DateTime.UtcNow.AddMinutes(_options.ExpirationMinutes);
    
    return GenerateToken(claims, expirationTime, JwtClaims.AccessTokenType);
}
````

**–©–æ —Ä–æ–±–∏—Ç—å:**

- –°—Ç–≤–æ—Ä—é—î claims (—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è) –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- –ì–µ–Ω–µ—Ä—É—î header —Ç–∞ payload
- –°—Ç–≤–æ—Ä—é—î HMAC SHA-256 –ø—ñ–¥–ø–∏—Å
- –ö–æ–¥—É—î –≤—Å–µ –≤ Base64URL —Ñ–æ—Ä–º–∞—Ç

### 2. JwtAuthenticationMiddleware - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω—ñ–≤

````csharp
public async Task InvokeAsync(HttpContext context)
{
    var token = ExtractTokenFromHeader(context);
    
    if (!string.IsNullOrEmpty(token))
    {
        var principal = _tokenGenerator.ValidateToken(token);
        if (principal != null && JwtTokenGenerator.IsAccessToken(principal))
        {
            context.User = principal;
            SetUserInfoInContext(context, principal);
        }
    }
    
    await _next(context);
}
````

</augment_code_snippet>

**–©–æ —Ä–æ–±–∏—Ç—å:**

- –í–∏—Ç—è–≥—É—î —Ç–æ–∫–µ–Ω –∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Authorization: Bearer <token>`
- –í–∞–ª—ñ–¥—É—î –ø—ñ–¥–ø–∏—Å —Ç–æ–∫–µ–Ω–∞
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó
- –í—Å—Ç–∞–Ω–æ–≤–ª—é—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç

### 3. –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π

````csharp
app.MapGet("/admin/dashboard", (HttpContext context) =>
{
    if (!context.IsAuthenticated())
        return JwtAuthenticationExtensions.Unauthorized();
    
    if (!context.IsAdmin())
        return JwtAuthenticationExtensions.Forbidden("–î–æ—Å—Ç—É–ø —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤");
    
    return Results.Ok(new { Message = "–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ—ó –ø–∞–Ω–µ–ª—ñ!" });
});
````

## üîê –ü—Ä–æ—Ü–µ—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó

### 1. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è/–í—Ö—ñ–¥

```mermaid
sequenceDiagram
    participant C as –ö–ª—ñ—î–Ω—Ç
    participant A as API
    participant DB as –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö
    
    C->>A: POST /auth/login
    A->>DB: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    DB->>A: –î–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    A->>A: –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è JWT —Ç–æ–∫–µ–Ω—ñ–≤
    A->>C: Access + Refresh —Ç–æ–∫–µ–Ω–∏
```

### 2. –î–æ—Å—Ç—É–ø –¥–æ –∑–∞—Ö–∏—â–µ–Ω–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤

```mermaid
sequenceDiagram
    participant C as –ö–ª—ñ—î–Ω—Ç
    participant M as Middleware
    participant E as –ï–Ω–¥–ø–æ—ñ–Ω—Ç
    
    C->>M: GET /protected + Bearer token
    M->>M: –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ç–æ–∫–µ–Ω–∞
    M->>M: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–ø–∏—Å—É
    M->>M: –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è User
    M->>E: –ü–µ—Ä–µ–¥–∞—á–∞ –∑–∞–ø–∏—Ç—É
    E->>C: –ó–∞—Ö–∏—â–µ–Ω—ñ –¥–∞–Ω—ñ
```

## üß™ –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: –ê–Ω–∞–ª—ñ–∑ —Ç–æ–∫–µ–Ω–∞

1. –£–≤—ñ–π–¥—ñ—Ç—å —è–∫ admin: `POST /auth/login`
2. –°–∫–æ–ø—ñ—é–π—Ç–µ Access —Ç–æ–∫–µ–Ω
3. –í—Å—Ç–∞–≤—Ç–µ –π–æ–≥–æ –Ω–∞ https://jwt.io
4. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π—Ç–µ header, payload —Ç–∞ signature

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏

1. –°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ payload —Ç–æ–∫–µ–Ω–∞
2. –°–ø—Ä–æ–±—É–π—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π —Ç–æ–∫–µ–Ω
3. –°–ø—Ä–æ–±—É–π—Ç–µ –¥–æ—Å—Ç—É–ø –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
4. –°–ø—Ä–æ–±—É–π—Ç–µ –¥–æ—Å—Ç—É–ø –∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ—é —Ä–æ–ª–ª—é

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ

1. –î–æ–¥–∞–π—Ç–µ –Ω–æ–≤—É —Ä–æ–ª—å "Moderator"
2. –°—Ç–≤–æ—Ä—ñ—Ç—å –µ–Ω–¥–ø–æ—ñ–Ω—Ç —Ç—ñ–ª—å–∫–∏ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ñ–≤
3. –î–æ–¥–∞–π—Ç–µ claim "permissions" –¥–æ —Ç–æ–∫–µ–Ω–∞

## üîß –Ø–∫ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–∞ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏

### 1. –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É

```bash
cd AspNet.MinimalApi.CustomJwtAuth
dotnet run
```

### 2. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ curl

```bash
# –í—Ö—ñ–¥
curl -X POST http://localhost:5100/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}'

# –ó–∞—Ö–∏—â–µ–Ω–∏–π —Ä–µ—Å—É—Ä—Å
curl http://localhost:5100/protected \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```bash
./test-jwt-auth.sh
```

## üÜö –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –≥–æ—Ç–æ–≤–∏–º–∏ —Ä—ñ—à–µ–Ω–Ω—è–º–∏

| –ê—Å–ø–µ–∫—Ç         | –ù–∞—à–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è                     | ASP.NET Core Identity        |
|----------------|-------------------------------------|------------------------------|
| **–ö–æ–Ω—Ç—Ä–æ–ª—å**   | –ü–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫–æ–∂–Ω–∏–º –∞—Å–ø–µ–∫—Ç–æ–º | –û–±–º–µ–∂–µ–Ω–∏–π –≥–æ—Ç–æ–≤–∏–º–∏ —Ä—ñ—à–µ–Ω–Ω—è–º–∏ |
| **–†–æ–∑—É–º—ñ–Ω–Ω—è**  | –ì–ª–∏–±–æ–∫–µ —Ä–æ–∑—É–º—ñ–Ω–Ω—è JWT               | –ü–æ–≤–µ—Ä—Ö–Ω–µ–≤–µ —Ä–æ–∑—É–º—ñ–Ω–Ω—è         |
| **–ì–Ω—É—á–∫—ñ—Å—Ç—å**  | –ú–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ –±—É–¥—å-—â–æ               | –°–∫–ª–∞–¥–Ω–æ –∫–∞—Å—Ç–æ–º—ñ–∑—É–≤–∞—Ç–∏        |
| **–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å** | –ü–æ—Ç—Ä—ñ–±–Ω–æ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –≤—Å–µ —Å–∞–º–æ–º—É     | –ì–æ—Ç–æ–≤–µ "–∑ –∫–æ—Ä–æ–±–∫–∏"           |
| **–ù–∞–≤—á–∞–Ω–Ω—è**   | –í—ñ–¥–º—ñ–Ω–Ω–æ –¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è               | –ü–æ–≥–∞–Ω–æ –¥–ª—è —Ä–æ–∑—É–º—ñ–Ω–Ω—è –æ—Å–Ω–æ–≤   |

## üîí –ë–µ–∑–ø–µ–∫–∞ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ

‚ö†Ô∏è **–ù–∞—à–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è!** –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ:

1. **–ó–æ–≤–Ω—ñ—à–Ω—î –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å–µ–∫—Ä–µ—Ç—ñ–≤**
   ```csharp
   // –ó–∞–º—ñ—Å—Ç—å appsettings.json
   var secretKey = Environment.GetEnvironmentVariable("JWT_SECRET");
   ```

2. **HTTPS –¥–ª—è –≤—Å—ñ—Ö –∑–∞–ø–∏—Ç—ñ–≤**
   ```csharp
   app.UseHttpsRedirection();
   ```

3. **Rate limiting**
   ```csharp
   app.UseRateLimiter();
   ```

4. **–í—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤**
   ```csharp
   // Blacklist –¥–ª—è –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤
   var isBlacklisted = await _tokenBlacklistService.IsBlacklistedAsync(token);
   ```

## üìö –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ—Å—É—Ä—Å–∏

- [RFC 7519 - JSON Web Token](https://tools.ietf.org/html/rfc7519)
- [JWT.io - Debugger](https://jwt.io/)
- [OWASP JWT Security](https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html)

## üéØ –í–∏—Å–Ω–æ–≤–∫–∏

–ü—ñ—Å–ª—è –≤–∏–≤—á–µ–Ω–Ω—è —Ü—å–æ–≥–æ –ø—Ä–æ–µ–∫—Ç—É –≤–∏:

‚úÖ –†–æ–∑—É–º—ñ—î—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É JWT —Ç–æ–∫–µ–Ω—ñ–≤  
‚úÖ –ó–Ω–∞—î—Ç–µ, —è–∫ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ç–∞ –≤–∞–ª—ñ–¥—É–≤–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å–∏  
‚úÖ –ú–æ–∂–µ—Ç–µ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –≤–ª–∞—Å–Ω—É —Å–∏—Å—Ç–µ–º—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó  
‚úÖ –†–æ–∑—É–º—ñ—î—Ç–µ –ø–µ—Ä–µ–≤–∞–≥–∏ —Ç–∞ –Ω–µ–¥–æ–ª—ñ–∫–∏ —Ä—ñ–∑–Ω–∏—Ö –ø—ñ–¥—Ö–æ–¥—ñ–≤  
‚úÖ –ì–æ—Ç–æ–≤—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≥–æ—Ç–æ–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è —É—Å–≤—ñ–¥–æ–º–ª–µ–Ω–æ

**–ì–æ–ª–æ–≤–Ω–µ:** –¢–µ–ø–µ—Ä –≤–∏ –∑–Ω–∞—î—Ç–µ, —â–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è "–ø—ñ–¥ –∫–∞–ø–æ—Ç–æ–º" JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó! üöÄ
